# API Documentation

## Architecture

The API is built using gRPC with a gRPC-Gateway that translates HTTP/JSON requests into gRPC calls. This architecture provides:

- Automatic API documentation generation from protobuf definitions
- Easy integration between HTTP/JSON and gRPC
- Type-safe API definitions

## Configuration Files

This project uses [buf](https://buf.build) to manage Protocol Buffer files and generation:

- **`buf.yaml`** - Main configuration file that sets up the buf module, including linting standards, breaking change detection rules, and external dependencies
- **`buf.gen.yaml`** - Code generation configuration that specifies which plugins to run, their output locations, and generation options for converting Protocol Buffer definitions into source code

## Endpoints (examples)

### Create Car

Creates a new car entity.

- **URL**: `/v1/cars`
- **Method**: `POST`
- **Request Body**:

  ```json
  {
    "tenant_id": "string",
    "model": "string"
  }
  ```

- **Response**:

  ```json
  {
    "car": {
      "id": "string",
      "tenant_id": "string",
      "model": "string",
      "created_at": "timestamp",
      "updated_at": "timestamp"
    }
  }
  ```

### Get Car

Retrieves a car by its ID.

- **URL**: `/v1/cars/{id}`
- **Method**: `GET`
- **Response**:

  ```json
  {
    "car": {
      "id": "string",
      "tenant_id": "string",
      "model": "string",
      "created_at": "timestamp",
      "updated_at": "timestamp"
    }
  }
  ```

### List Cars

Retrieves a list of cars for a tenant with pagination support.

- **URL**: `/v1/cars`
- **Method**: `GET`
- **Query Parameters**:
  - `tenant_id` (required): The tenant ID to filter cars
  - `page_size` (optional): Number of cars to return per page (default: 10)
  - `page_token` (optional): Token for pagination

- **Response**:

  ```json
  {
    "cars": [
      {
        "id": "string",
        "tenant_id": "string",
        "model": "string",
        "created_at": "timestamp",
        "updated_at": "timestamp"
      }
    ],
    "next_page_token": "string"
  }
  ```

## Protocol Buffers

The API is defined using Protocol Buffers in the following files:

- `api/proto/car/v1/car.proto` - Defines the Car message structure
- `api/proto/car/v1/car_service.proto` - Defines the gRPC service and methods:
  - `CreateCar` - Creates a new car
  - `GetCar` - Retrieves a car by ID
  - `ListCars` - Retrieves a list of cars with pagination

## Implementation

The API is implemented in the following directories:

- `internal/interface/grpc/car/v1/service.go` - gRPC service implementation
- `internal/interface/http/server.go` - HTTP server with gRPC-Gateway

## Code Generation

To generate code from Protocol Buffer definitions, follow these steps:

1. **Modify Protocol Buffer files**:
   - Update `api/proto/car/v1/car.proto` for message definitions
   - Update `api/proto/car/v1/car_service.proto` for service definitions
   - Update `api/proto/common/v1/common.proto` for common message types

2. **Lint Protocol Buffer files**:
   Run the following command to check for any issues in the Protocol Buffer definitions:

   ```bash
   make lint.proto
   ```

3. **Generate Go code**:
   Run the following command to generate Go code from the Protocol Buffer definitions:

   ```bash
   make gen.proto
   ```

4. **Generated files**:
   The following files are generated:
   - `api/generated/car/v1/car.pb.go` - Message types
   - `api/generated/car/v1/car_grpc.pb.go` - gRPC service interface
   - `api/generated/car/v1/car.pb.gw.go` - gRPC-Gateway handlers
   - `api/generated/common/v1/common.pb.go` - Common message types

### buf.gen.yaml Configuration

The `buf.gen.yaml` file configures how Protocol Buffer files are processed to generate code:

- **go plugin** - Generates Go message types (`*.pb.go`)
- **go-grpc plugin** - Generates gRPC service interfaces (`*_grpc.pb.go`)
- **grpc-gateway plugin** - Generates HTTP/JSON to gRPC gateway code (`*.pb.gw.go`)

All generated code is placed in the `api/generated` directory with paths relative to the source files.

## API Endpoint Information

To view and verify API endpoint information:

1. **Check generated documentation**:
   The gRPC-Gateway automatically generates OpenAPI/Swagger documentation from the Protocol Buffer definitions.
   When the server is running, you can access the API documentation at:
   - `http://localhost:8080/swagger/` - Swagger UI
   - `http://localhost:8080/openapi.json` - OpenAPI JSON specification

2. **View endpoint definitions**:
   All API endpoints are defined in the Protocol Buffer service definitions:
   - `api/proto/car/v1/car_service.proto` - Contains all car-related service methods

3. **Check HTTP mappings**:
   The HTTP-to-gRPC mappings are automatically generated by the gRPC-Gateway based on the service definitions.
   You can see the mappings in the generated gateway files:
   - `api/generated/car/v1/car.pb.gw.go` - Contains HTTP route mappings

## Usage

To start the API server, run the main application which will start both the gRPC server and the HTTP gateway.
