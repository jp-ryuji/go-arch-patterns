# Ent and Gqlgen Setup and Usage

This document provides a comprehensive guide on setting up and using Ent and Gqlgen in this project. Ent is an entity framework for Go that helps developers build and maintain applications with large data models. Gqlgen is a Go library for building GraphQL servers without any fuss.

## Table of Contents

- [Ent and Gqlgen Setup and Usage](#ent-and-gqlgen-setup-and-usage)
  - [Table of Contents](#table-of-contents)
  - [Introduction](#introduction)
  - [Project Structure](#project-structure)
  - [Installation](#installation)
  - [Ent Setup](#ent-setup)
    - [Schema Definition](#schema-definition)
    - [Code Generation](#code-generation)
  - [Gqlgen Setup](#gqlgen-setup)
    - [Schema Definition](#schema-definition-1)
    - [Code Generation](#code-generation-1)
  - [Integration](#integration)
    - [Resolver Implementation](#resolver-implementation)
    - [Server Setup](#server-setup)
  - [Usage](#usage)
    - [Running the Server](#running-the-server)
    - [Testing with GraphQL Playground](#testing-with-graphql-playground)
  - [Conclusion](#conclusion)

## Introduction

This project uses Ent as an ORM and Gqlgen for GraphQL implementation. Together, they provide a powerful and efficient way to build GraphQL APIs with Go. Ent helps manage the data layer with type-safe queries, while Gqlgen generates the GraphQL server code based on your schema.

**Note:** Both Ent and Gqlgen command-line tools are properly declared as tool dependencies in the `go.mod` file, ensuring consistent versions across all development environments.

## Project Structure

The project follows a clear separation between manually edited files and auto-generated files:

- `schema/graphql/schema.graphql` - Manually written GraphQL schema definitions (types, queries, mutations)
- `internal/ent/schema/` - Manually written Ent schema definitions
- `internal/ent/` (except schema/) - Auto-generated Ent code
- `internal/graphql/` (except schema files) - Auto-generated GraphQL code

This structure makes it clear which files are safe to edit and which are generated automatically.

**Important Notes:**

- Files in `internal/ent/schema/` are manually created and define the Ent entity schemas
- Files in `internal/ent/` (except the schema directory) are auto-generated by Ent and should not be manually modified
- `schema/graphql/schema.graphql` is manually created and defines the complete GraphQL API schema (types, inputs, queries, and mutations)
- Files in `internal/graphql/` (except schema files) are auto-generated by Gqlgen and should not be manually modified

## Installation

**Note:** You can skip this section if you already have installed all dependencies with `go mod tidy`.

To install the required dependencies, run:

```bash
go get entgo.io/ent@latest
go get github.com/99designs/gqlgen@latest
go get entgo.io/contrib@latest
```

Additionally, install the Ent and Gqlgen command-line tools:

```bash
# Install all tool dependencies declared in go.mod
go install tool
```

## Ent Setup

### Schema Definition

Ent schemas are defined in `internal/ent/schema/`. Each entity has its own schema file that defines its fields, edges (relationships), and indexes.

Example schema for a Tenant entity:

```go
// internal/ent/schema/tenant.go
package schema

import (
    "entgo.io/contrib/entgql"
    "entgo.io/ent"
    "entgo.io/ent/schema/field"
    "entgo.io/ent/schema/index"
)

// Tenant holds the schema definition for the Tenant entity.
type Tenant struct {
    ent.Schema
}

// Fields of the Tenant.
func (Tenant) Fields() []ent.Field {
    return []ent.Field{
        field.String("id").
            Unique().
            NotEmpty().
            Annotations(
                entgql.OrderField("ID"),
            ),
        field.String("code").
            Unique().
            NotEmpty().
            Annotations(
                entgql.OrderField("CODE"),
            ),
    }
}

// Edges of the Tenant.
func (Tenant) Edges() []ent.Edge {
    return []ent.Edge{
        // Add edges here if needed
    }
}

// Indexes of the Tenant.
func (Tenant) Indexes() []ent.Index {
    return []ent.Index{
        index.Fields("code").
            Unique(),
    }
}
```

### Code Generation

To generate the Ent code, run:

```bash
go generate ./internal/ent
```

This command will generate all the necessary code for your entities in the `internal/ent/` directory.

## Gqlgen Setup

### Schema Definition

GraphQL schemas are defined in `schema/graphql/schema.graphql`. This file defines the types, queries, and mutations for your API.

Example schema:

```graphql
# schema/graphql/schema.graphql
type Tenant {
  id: ID!
  code: String!
  cars: [Car!]!
}

input CreateTenantInput {
  code: String!
}

type Mutation {
  createTenant(input: CreateTenantInput!): Tenant!
}

type Query {
  tenants: [Tenant!]!
  tenant(id: ID!): Tenant
}
```

**Note:** Only `schema.graphql` is required. Any `schema.graphqls` files in the same directory are not needed and can be safely removed.

### Code Generation

To generate the Gqlgen code, run:

```bash
go run github.com/99designs/gqlgen generate
```

This command will generate the GraphQL server code in the `internal/graphql/` directory.

## Integration

### Resolver Implementation

The resolvers connect the GraphQL API to the Ent database layer. They are implemented in `internal/graphql/schema.resolvers.go`.

Example resolver implementation:

```go
// CreateTenant is the resolver for the createTenant field.
func (r *mutationResolver) CreateTenant(ctx context.Context, input model.CreateTenantInput) (*model.Tenant, error) {
    // Generate a new UUID for the tenant
    id := uuid.New().String()

    // Create the tenant in the database
    t, err := r.client.Tenant.Create().
        SetID(id).
        SetCode(input.Code).
        Save(ctx)

    if err != nil {
        return nil, err
    }

    // Convert the ent tenant to the GraphQL model
    return &model.Tenant{
        ID:   t.ID,
        Code: t.Code,
    }, nil
}
```

### Server Setup

The GraphQL server is set up in `cmd/graphql/main.go`:

```go
func main() {
    port := os.Getenv("PORT")
    if port == "" {
        port = defaultPort
    }

    // Initialize the ent client
    client := database.NewClient()
    defer client.Close()

    // Create the GraphQL resolver with the ent client
    resolver := graphql.NewResolver(client)

    srv := handler.NewDefaultServer(graphql.NewExecutableSchema(graphql.Config{Resolvers: resolver}))

    http.Handle("/", playground.Handler("GraphQL playground", "/query"))
    http.Handle("/query", srv)

    log.Printf("connect to http://localhost:%s/ for GraphQL playground", port)
    log.Fatal(http.ListenAndServe(":"+port, nil))
}
```

## Usage

### Running the Server

To run the GraphQL server, execute:

```bash
go run cmd/graphql/main.go
```

The server will start on port 8080 by default.

### Testing with GraphQL Playground

Once the server is running, you can access the GraphQL Playground at `http://localhost:8080`. From there, you can test your queries and mutations.

Example query:

```graphql
query {
  tenants {
    id
    code
  }
}
```

Example mutation:

```graphql
mutation {
  createTenant(input: {code: "example"}) {
    id
    code
  }
}
```

## Conclusion

This setup provides a robust foundation for building GraphQL APIs with Go, using Ent for data modeling and Gqlgen for GraphQL implementation. The combination allows for type-safe database operations and automatic generation of GraphQL server code, making development faster and more reliable.
